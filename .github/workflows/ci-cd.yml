name: Veille Pipeline CI/CD

on:
  # Déclenchement manuel
  workflow_dispatch:
  
  # Exécution quotidienne à 8h00 (Paris)
  schedule:
    - cron: '0 7 * * *'  # 7h UTC = 8h Paris (heure d'hiver)
  
  # Sur push sur main (pour tests)
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  # Job 1: Tests et validation
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8 black
    
    - name: Lint with flake8
      run: |
        flake8 pipeline_veille.py --max-line-length=120 --ignore=E501,W503
      continue-on-error: true
    
    - name: Check code formatting with black
      run: |
        black --check pipeline_veille.py
      continue-on-error: true
    
    - name: Run unit tests
      run: |
        pytest test_pipeline_mock.py -v
  
  # Job 2: Exécution du pipeline
  run-pipeline:
    runs-on: ubuntu-latest
    needs: test  # Attend que les tests passent
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create credentials file
      run: |
        echo "${{ secrets.GOOGLE_CREDENTIALS }}" > credentials.json
    
    - name: Configure API keys
      run: |
        sed -i 's/VOTRE_CLE_GEMINI_ICI/${{ secrets.GEMINI_API_KEY }}/g' pipeline_veille.py
        sed -i 's/SEARCH_API_KEY = ".*"/SEARCH_API_KEY = "${{ secrets.SEARCH_API_KEY }}"/g' pipeline_veille.py
    
    - name: Run pipeline
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SEARCH_API_KEY: ${{ secrets.SEARCH_API_KEY }}
      run: |
        python pipeline_veille.py
    
    - name: Upload execution logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: pipeline-logs
        path: |
          *.log
          chroma_db/
        retention-days: 7
    
    - name: Notify on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_SENDER }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "❌ Pipeline Veille - Échec d'exécution"
        body: "Le pipeline de veille a échoué. Consultez les logs dans GitHub Actions."
        to: ${{ secrets.EMAIL_SENDER }}
        from: GitHub Actions
