<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Veille Réglementaire - GDD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Stats Dynamiques (Injectées par Python) -->
    <script src="output/dashboard_stats.js"></script>
    <!-- FontAwesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
        }

        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #e2e8f0;
            transform: translateX(-50%);
        }

        @media (max-width: 768px) {
            .timeline-line {
                left: 20px;
            }
        }

        /* Tabs Styling */
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #1a1f36 0%, #2d3748 100%);
            color: white;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #d64545;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Iframe styling for checklists */
        .checklist-iframe {
            width: 100%;
            min-height: 800px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="text-gray-700">

    <!-- En-tête -->
    <header class="bg-gradient-to-r from-slate-800 to-slate-700 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div
                    class="bg-white text-slate-800 p-2 rounded-lg font-bold text-xl h-10 w-10 flex items-center justify-center">
                    G
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">Générale de Découpage (GDD)</h1>
                    <p class="text-xs md:text-sm text-slate-300">Tableau de Bord Veille Réglementaire & Environnementale
                        (ISO 14001)</p>
                </div>
            </div>
            <button onclick="window.print()"
                class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-md shadow transition hidden md:block">
                <i class="fas fa-print mr-2"></i>Imprimer / PDF
            </button>
        </div>
    </header>

    <!-- Navigation par Onglets -->
    <div class="bg-white shadow-md sticky top-[72px] z-40">
        <div class="container mx-auto px-4">
            <nav class="flex space-x-1 overflow-x-auto">
                <button onclick="switchTab('dashboard')"
                    class="tab-button active px-6 py-4 font-semibold text-sm whitespace-nowrap focus:outline-none">
                    <i class="fas fa-chart-line mr-2"></i>Tableau de Bord
                </button>
                <button onclick="switchTab('nouveautes')"
                    class="tab-button px-6 py-4 font-semibold text-sm whitespace-nowrap focus:outline-none bg-gray-100 hover:bg-gray-200">
                    <i class="fas fa-newspaper mr-2"></i>Checklist Nouveautés
                </button>
                <button onclick="switchTab('base-active')"
                    class="tab-button px-6 py-4 font-semibold text-sm whitespace-nowrap focus:outline-none bg-gray-100 hover:bg-gray-200">
                    <i class="fas fa-clipboard-check mr-2"></i>Checklist Base Active
                </button>

                <button onclick="switchTab('methodologie')"
                    class="tab-button px-6 py-4 font-semibold text-sm whitespace-nowrap focus:outline-none bg-gray-100 hover:bg-gray-200">
                    <i class="fas fa-info-circle mr-2"></i>Méthodologie
                </button>
                <button onclick="switchTab('recherche')" id="tab-search-btn"
                    class="tab-button hidden px-6 py-4 font-semibold text-sm whitespace-nowrap focus:outline-none bg-gray-100 hover:bg-gray-200">
                    <i class="fas fa-search mr-2"></i>Recherche
                </button>
            </nav>
            <!-- Search Bar -->
            <div class="hidden lg:flex items-center ml-4">
                <div class="relative">
                    <input type="text" id="global-search" onkeyup="if(event.key==='Enter') executeSearch()"
                        placeholder="Rechercher (ex: mise à la terre)..."
                        class="pl-10 pr-4 py-2 border rounded-full text-sm focus:ring-2 focus:ring-slate-800 outline-none w-80">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu des Onglets -->
    <main class="container mx-auto px-4 py-8">

        <!-- ONGLET 4: RECHERCHE -->
        <div id="recherche" class="tab-content">
            <div class="bg-white rounded-xl shadow-md p-8 min-h-[600px]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-search mr-3 text-slate-800"></i>
                        Résultats pour : <span id="search-query-label" class="ml-2 text-slate-400 italic">...</span>
                    </h2>
                    <span id="search-count"
                        class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm font-medium">0 résultat</span>
                </div>
                <div id="search-results" class="grid grid-cols-1 gap-6">
                    <!-- Injecté par JS -->
                    <div class="text-center py-20 text-gray-400">
                        <i class="fas fa-search fa-3x mb-4 opacity-20"></i>
                        <p>Saisissez un mot-clé ci-dessus et appuyez sur Entrée</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ONGLET 1: TABLEAU DE BORD -->
        <div id="dashboard" class="tab-content active">

            <!-- Section 1: KPI (Indicateurs Clés) -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- KPI 1 -->
                <div class="bg-white rounded-xl shadow-md p-6 card border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-medium uppercase">Total Textes Suivis</p>
                            <h3 id="kpi-total" class="text-3xl font-bold text-gray-800 mt-1">1,328</h3>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-full text-blue-600">
                            <i class="fas fa-book fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Base active générale</p>
                </div>

                <!-- KPI 2 -->
                <div class="bg-white rounded-xl shadow-md p-6 card border-l-4 border-emerald-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-medium uppercase">Textes Applicables</p>
                            <h3 id="kpi-applicable" class="text-3xl font-bold text-gray-800 mt-1">310</h3>
                        </div>
                        <div class="p-3 bg-emerald-100 rounded-full text-emerald-600">
                            <i class="fas fa-check-circle fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Avec actions définies</p>
                </div>

                <!-- KPI 3 -->
                <div class="bg-white rounded-xl shadow-md p-6 card border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-medium uppercase">Actions Requises</p>
                            <h3 id="kpi-actions" class="text-3xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="p-3 bg-orange-100 rounded-full text-orange-600">
                            <i class="fas fa-exclamation-triangle fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1">
                        <p class="text-[10px] flex justify-between"><span>À mettre en place:</span> <span id="sub-mec"
                                class="font-bold text-red-600">0</span></p>
                        <p class="text-[10px] flex justify-between"><span>Réévaluation:</span> <span id="sub-reeval"
                                class="font-bold text-blue-600">0</span></p>
                        <p class="text-[10px] flex justify-between"><span>À qualifier:</span> <span id="sub-qualif"
                                class="font-bold text-gray-600">0</span></p>
                    </div>
                </div>

                <!-- KPI 4 -->
                <div class="bg-white rounded-xl shadow-md p-6 card border-l-4 border-indigo-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-medium uppercase">Score de Preuves</p>
                            <h3 id="kpi-proofs" class="text-3xl font-bold text-gray-800 mt-1">0%</h3>
                        </div>
                        <div class="p-3 bg-indigo-100 rounded-full text-indigo-600">
                            <i class="fas fa-shield-check fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Preuves disponibles pour audit</p>
                </div>
            </section>

            <!-- Section 2: Graphiques & Répartition -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

                <!-- Graphique Répartition Thématique -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 text-sm uppercase tracking-wider">
                        <i class="fas fa-chart-pie mr-2 text-slate-400"></i>Par Thème
                    </h2>
                    <div class="h-64 relative">
                        <canvas id="themeChart"></canvas>
                    </div>
                </div>

                <!-- Graphique Conformité -->
                <div class="bg-white rounded-xl shadow-md p-6 border-t-2 border-emerald-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 text-sm uppercase tracking-wider">
                        <i class="fas fa-shield-halved mr-2 text-emerald-500"></i>Conformité Globale
                    </h2>
                    <div class="h-64 relative">
                        <canvas id="complianceChart"></canvas>
                    </div>
                </div>

                <!-- Graphique Criticité -->
                <div class="bg-white rounded-xl shadow-md p-6 border-t-2 border-slate-700">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 text-sm uppercase tracking-wider">
                        <i class="fas fa-bolt mr-2 text-slate-800"></i>Répartition Criticité
                    </h2>
                    <div class="h-64 relative">
                        <canvas id="criticiteChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Section 3: Frise Chronologique -->
            <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-lg font-bold text-gray-800 mb-8 border-b pb-2 text-center">
                    <i class="fas fa-clock mr-2 text-slate-600"></i>Calendrier Réglementaire Prévisionnel
                </h2>

                <div class="relative py-4">
                    <div class="timeline-line hidden md:block"></div>

                    <div class="space-y-8 relative">
                        <!-- Event 2024 -->
                        <div class="md:flex items-center justify-between w-full">
                            <div class="order-1 w-5/12 hidden md:block"></div>
                            <div
                                class="z-20 flex items-center order-1 bg-slate-800 shadow-xl w-8 h-8 rounded-full ml-[19px] md:ml-0 md:mr-0 mr-auto">
                                <h1 class="mx-auto font-semibold text-xs text-white">2024</h1>
                            </div>
                            <div
                                class="order-1 bg-gray-50 rounded-lg shadow-sm w-full md:w-5/12 px-6 py-4 border-l-4 border-slate-500 ml-4 md:ml-0">
                                <h3 class="mb-1 font-bold text-gray-800 text-sm">Sécurité des produits (RSGP)</h3>
                                <p class="text-xs text-gray-600 leading-snug">Règlement (UE) 2023/988. Renforcement des
                                    exigences de sécurité pour les produits mis sur le marché UE.</p>
                                <span class="text-xs font-mono text-slate-400 mt-2 block">Date: 13 Déc 2024</span>
                            </div>
                        </div>

                        <!-- Event 2025 -->
                        <div class="md:flex items-center justify-between w-full flex-row-reverse">
                            <div class="order-1 w-5/12 hidden md:block"></div>
                            <div
                                class="z-20 flex items-center order-1 bg-emerald-600 shadow-xl w-8 h-8 rounded-full ml-[19px] md:ml-0">
                                <h1 class="mx-auto font-semibold text-xs text-white">2025</h1>
                            </div>
                            <div
                                class="order-1 bg-emerald-50 rounded-lg shadow-sm w-full md:w-5/12 px-6 py-4 border-l-4 border-emerald-500 ml-4 md:mr-0">
                                <h3 class="mb-1 font-bold text-emerald-900 text-sm">REP Emballages Industriels &
                                    Commerciaux</h3>
                                <p class="text-xs text-emerald-800 leading-snug">Extension de la Responsabilité Élargie
                                    du Producteur aux emballages pro. Contrats avec éco-organismes obligatoires.</p>
                                <span class="text-xs font-mono text-emerald-600 mt-2 block">Date: 01 Jan 2025</span>
                            </div>
                        </div>

                        <!-- Event 2026 -->
                        <div class="md:flex items-center justify-between w-full">
                            <div class="order-1 w-5/12 hidden md:block"></div>
                            <div
                                class="z-20 flex items-center order-1 bg-blue-500 shadow-xl w-8 h-8 rounded-full ml-[19px] md:ml-0">
                                <h1 class="mx-auto font-semibold text-xs text-white">2026</h1>
                            </div>
                            <div
                                class="order-1 bg-blue-50 rounded-lg shadow-sm w-full md:w-5/12 px-6 py-4 border-l-4 border-blue-500 ml-4 md:ml-0">
                                <h3 class="mb-1 font-bold text-blue-900 text-sm">Matériaux contact alimentaire</h3>
                                <p class="text-xs text-blue-800 leading-snug">Règlement 2022/1616. Nouvelles exigences
                                    pour les plastiques recyclés.</p>
                            </div>
                        </div>

                        <!-- Event 2030 -->
                        <div class="md:flex items-center justify-between w-full flex-row-reverse">
                            <div class="order-1 w-5/12 hidden md:block"></div>
                            <div
                                class="z-20 flex items-center order-1 bg-purple-600 shadow-xl w-8 h-8 rounded-full ml-[19px] md:ml-0">
                                <h1 class="mx-auto font-semibold text-xs text-white">2030</h1>
                            </div>
                            <div
                                class="order-1 bg-purple-50 rounded-lg shadow-sm w-full md:w-5/12 px-6 py-4 border-l-4 border-purple-500 ml-4 md:mr-0">
                                <h3 class="mb-1 font-bold text-purple-900 text-sm">Décret Tertiaire (Objectif 1)</h3>
                                <p class="text-xs text-purple-800 leading-snug">Réduction de 40% de la consommation
                                    énergétique par rapport à l'année de référence.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 4: Procédure de Veille -->
            <section class="mb-8">
                <h2 class="text-lg font-bold text-gray-800 mb-6 text-center">Processus de Gestion de la Conformité (ISO
                    14001)</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                    <!-- Step 1 -->
                    <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition">
                        <div
                            class="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">1. Collecte</h4>
                        <p class="text-xs text-gray-500">Sources : JOUE, Legifrance, APORA, Alsape.</p>
                    </div>
                    <!-- Step 2 -->
                    <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition">
                        <div
                            class="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">
                            <i class="fas fa-filter"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">2. Tri & Analyse</h4>
                        <p class="text-xs text-gray-500">Resp. QSE détermine l'applicabilité (ICPE, 14001).</p>
                    </div>
                    <!-- Step 3 -->
                    <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition">
                        <div
                            class="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">3. Plan d'Action</h4>
                        <p class="text-xs text-gray-500">Définition des actions de mise en conformité et responsables.
                        </p>
                    </div>
                    <!-- Step 4 -->
                    <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition">
                        <div
                            class="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">4. Évaluation</h4>
                        <p class="text-xs text-gray-500">Audit de conformité et reporting mensuel.</p>
                    </div>
                </div>
            </section>

        </div>

        <!-- ONGLET 2: CHECKLIST NOUVEAUTÉS -->
        <div id="nouveautes" class="tab-content">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-newspaper mr-2 text-yellow-500"></i>Checklist Nouveautés Réglementaires
                    </h2>
                    <a href="output/checklist_nouveautes.html" target="_blank"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm transition">
                        <i class="fas fa-external-link-alt mr-2"></i>Ouvrir en plein écran
                    </a>
                </div>
                <iframe src="output/checklist_nouveautes.html" class="checklist-iframe"></iframe>
            </div>
        </div>

        <!-- ONGLET 3: CHECKLIST BASE ACTIVE -->
        <div id="base-active" class="tab-content">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-clipboard-check mr-2 text-green-500"></i>Checklist Base Active
                    </h2>
                    <a href="output/checklist_base_active.html" target="_blank"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm transition">
                        <i class="fas fa-external-link-alt mr-2"></i>Ouvrir en plein écran
                    </a>
                </div>
                <iframe src="output/checklist_base_active.html" class="checklist-iframe"></iframe>
            </div>
        </div>




        <!-- ONGLET 7: MÉTHODOLOGIE -->
        <div id="methodologie" class="tab-content transition-all duration-300">
            <div class="bg-white rounded-xl shadow-md p-8 border border-slate-100">
                <div class="flex items-center gap-4 mb-10">
                    <div class="p-3 bg-blue-100 rounded-lg text-blue-600">
                        <i class="fas fa-microscope fa-2x"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Méthodologie & Fonctionnement</h2>
                        <p class="text-slate-500">Comprendre le moteur de veille réglementaire de GDD</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8 mb-10">
                    <div class="space-y-6">
                        <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-shield-alt text-blue-500"></i> Garantie d'Exhaustivité
                        </h3>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-100">
                            <p class="text-sm text-slate-700 leading-relaxed mb-4">
                                Notre système repose sur une veille <strong>active "Open-Web"</strong> qui ne se limite
                                pas à des URLs statiques.
                            </p>
                            <ul class="space-y-3 text-xs text-slate-600">
                                <li class="flex gap-2"><i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                                    <span><strong>Scan Intégral (Google API)</strong> : Utilisation de l'index mondial
                                        pour
                                        scanner l'intégralité du web accessible.</span>
                                </li>
                                <li class="flex gap-2"><i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                                    <span><strong>Double Validation (IA)</strong> : Filtrage de pertinence par Gemini
                                        1.5 Pro pour garantir l'absence de "bruit".</span>
                                </li>
                                <li class="flex gap-2"><i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                                    <span><strong>Analyse d'Écart (Gap Analysis)</strong> : Audit mensuel automatisé
                                        pour identifier tout manquement historique.</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-brain text-purple-500"></i> Intelligence Artificielle (RAG)
                        </h3>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-100">
                            <p class="text-sm text-slate-700 leading-relaxed mb-4">
                                Chaque texte détecté passe par un <strong>triple filtrage</strong> avant d'être intégré
                                au tableau de bord.
                            </p>
                            <ul class="space-y-3 text-xs text-slate-600">
                                <li class="flex gap-2"><i class="fas fa-robot text-purple-500 mt-1"></i>
                                    <span><strong>Validation de Pertinence</strong> : L'IA écarte les bruits de fond
                                        pour ne garder que le substantiel métier.</span>
                                </li>
                                <li class="flex gap-2"><i class="fas fa-project-diagram text-purple-500 mt-1"></i>
                                    <span><strong>Analyse ISO 14001</strong> : Extraction automatique des seuils et
                                        exigences de conformité.</span>
                                </li>
                                <li class="flex gap-2"><i class="fas fa-file-signature text-purple-500 mt-1"></i>
                                    <span><strong>Identification des Preuves</strong> : Détermination du document exact
                                        à présenter en audit.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                        <i class="fas fa-balance-scale text-amber-500"></i> Calcul de la Criticité (Méthode KPR)
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm border-collapse bg-slate-50 rounded-xl overflow-hidden">
                            <thead>
                                <tr class="bg-slate-200 text-slate-700 uppercase text-xs font-bold">
                                    <th class="px-6 py-4">Niveau</th>
                                    <th class="px-6 py-4">Logique Auditoriale</th>
                                    <th class="px-6 py-4">Impact Opérationnel</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-slate-100 hover:bg-slate-100 transition">
                                    <td class="px-6 py-4"><span
                                            class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold">HAUTE</span>
                                    </td>
                                    <td class="px-6 py-4">Sanction pénale, Changement de VLE, MAJ Arrêté ICPE.</td>
                                    <td class="px-6 py-4">Arrêt d'activité ou mise en demeure immédiate.</td>
                                </tr>
                                <tr class="border-b border-slate-100 hover:bg-slate-100 transition">
                                    <td class="px-6 py-4"><span
                                            class="bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-xs font-bold">MOYENNE</span>
                                    </td>
                                    <td class="px-6 py-4">Obligation de reporting (REP), Investissement mineur.</td>
                                    <td class="px-6 py-4">Risque de non-conformité majeure en audit.</td>
                                </tr>
                                <tr class="hover:bg-slate-100 transition">
                                    <td class="px-6 py-4"><span
                                            class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-xs font-bold">BASSE</span>
                                    </td>
                                    <td class="px-6 py-4">Mise à jour Cerfa, Changement de site web adm.</td>
                                    <td class="px-6 py-4">Piste d'amélioration ou simple mise à jour documentaire.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-10 p-6 bg-blue-50 rounded-xl border border-blue-100">
                    <div class="flex items-start gap-4">
                        <div class="text-blue-600 mt-1">
                            <i class="fas fa-info-circle fa-lg"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-blue-900 mb-2">Note pour l'Auditeur Certification</h4>
                            <p class="text-sm text-blue-800 leading-relaxed mb-4">
                                Ce système est conçu pour répondre aux exigences du chapitre 6.1.3 ("Obligations de
                                conformité")
                                et 9.1.2 ("Évaluation de la conformité") de la norme ISO 14001:2015.
                            </p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="text-xl font-bold text-blue-600">994</div>
                                    <div class="text-[10px] text-gray-500 uppercase">Suivis</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="text-xl font-bold text-emerald-600">291</div>
                                    <div class="text-[10px] text-gray-500 uppercase">Applicables</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="text-xl font-bold text-amber-600">261</div>
                                    <div class="text-[10px] text-gray-500 uppercase">Actions</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="text-xl font-bold text-purple-600">
                                        <10%< /div>
                                            <div class="text-[10px] text-gray-500 uppercase">Divers</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </main>

    <footer class="bg-slate-800 text-slate-400 py-6 text-center text-xs">
        <p id="last-update-text">Mise à jour méthodologique le 18/02/2026 pour Générale de Découpage.</p>
        <p class="mt-1">Données vérifiées depuis Google Sheets - Base Active & Rapport de Veille.</p>
    </footer>

    <!-- Scripts -->
    <script>
        // Fonction de changement d'onglet
        function switchTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
                button.classList.add('bg-gray-100', 'hover:bg-gray-200');
            });

            document.getElementById(tabId).classList.add('active');

            // Trouver le bouton correspondant
            const activeBtn = Array.from(buttons).find(btn => btn.getAttribute('onclick').includes(`'${tabId}'`));
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
            }
        }

        async function executeSearch() {
            const query = document.getElementById('global-search').value.trim();
            if (!query) return;

            document.getElementById('search-query-label').innerText = query;
            document.getElementById('tab-search-btn').classList.remove('hidden');
            switchTab('recherche');

            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="text-center py-20"><i class="fas fa-spinner fa-spin fa-3x text-slate-300"></i><p class="mt-4 text-gray-500">Recherche dans la base de données...</p></div>';

            try {
                const res = await fetch(`http://localhost:5000/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                document.getElementById('search-count').innerText = `${data.length} résultat${data.length > 1 ? 's' : ''}`;

                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-400">Aucun résultat trouvé pour cette recherche.</div>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div class="border rounded-lg p-6 hover:border-slate-400 transition shadow-sm bg-white border-l-4 ${item.source_sheet === 'Base_Active' ? 'border-l-blue-500' : 'border-l-orange-500'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="text-[10px] font-bold uppercase tracking-wider ${item.source_sheet === 'Base_Active' ? 'text-blue-600 bg-blue-50' : 'text-orange-600 bg-orange-50'} px-2 py-1 rounded">
                                    ${item.source_sheet === 'Base_Active' ? 'Base Active' : 'Nouveautés'}
                                </span>
                            </div>
                            <span class="text-xs text-gray-400 font-medium">Ligne ID: ${item.row_idx}</span>
                        </div>
                        <h3 class="font-bold text-lg mb-2 text-slate-800">
                            <a href="${item.url}" target="_blank" class="hover:text-blue-600 underline decoration-slate-300 underline-offset-4">${item.Intitulé}</a>
                        </h3>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded font-medium">${item.Thème}</span>
                            <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded font-medium">${item['Type de texte']}</span>
                            <span class="text-[10px] ${item.Conformité === 'C' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} px-2 py-1 rounded font-bold uppercase">
                                Conformité: ${item.Conformité || 'NC'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 leading-relaxed">${item.Commentaires || 'Pas de résumé disponible.'}</p>
                        ${item['Commentaires (ALSAPE, APORA…)'] ? `
                            <div class="mt-4 pt-4 border-t border-dashed border-gray-100">
                                <p class="text-xs font-semibold text-slate-500 uppercase mb-1">Observations :</p>
                                <p class="text-sm italic text-slate-600">${item['Commentaires (ALSAPE, APORA…)']}</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

            } catch (e) {
                container.innerHTML = '<div class="text-center py-20 text-red-500 bg-red-50 rounded-lg"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Erreur : Impossible de joindre le serveur. Assurez-vous que le serveur de synchronisation est lancé.</p></div>';
            }
        }

        // Chargement dynamique des données
        function loadDashboardData() {
            try {
                // DASHBOARD_DATA est injecté via dashboard_stats.js
                const stats = DASHBOARD_DATA;

                // Mise à jour des KPIs
                document.getElementById('kpi-total').textContent = stats.kpis.total_tracked.toLocaleString();
                document.getElementById('kpi-applicable').textContent = stats.kpis.applicable.toLocaleString();
                document.getElementById('kpi-actions').textContent = stats.kpis.actions_required.toLocaleString();
                document.getElementById('kpi-proofs').textContent = stats.kpis.proof_score;

                // Sous-catégories
                document.getElementById('sub-mec').textContent = stats.kpis.sub_mec;
                document.getElementById('sub-reeval').textContent = stats.kpis.sub_reeval;
                document.getElementById('sub-qualif').textContent = stats.kpis.sub_qualif;


                document.getElementById('last-update-text').textContent = "Généré le " + stats.last_update + " pour Générale de Découpage.";

                // Calcul des % pour les thèmes
                const totalThemes = stats.themes.values.reduce((a, b) => a + b, 0);
                const themeLabels = stats.themes.labels.map((l, i) => {
                    const pct = totalThemes > 0 ? Math.round((stats.themes.values[i] / totalThemes) * 100) : 0;
                    return `${l} (${pct}%)`;
                });

                // Calcul des % pour la conformité
                const totalComp = stats.compliance.values.reduce((a, b) => a + b, 0);
                const compLabels = stats.compliance.labels.map((l, i) => {
                    const pct = totalComp > 0 ? Math.round((stats.compliance.values[i] / totalComp) * 100) : 0;
                    return `${l} (${pct}%)`;
                });

                // Mise à jour du graphique
                const ctxTheme = document.getElementById('themeChart').getContext('2d');
                new Chart(ctxTheme, {
                    type: 'doughnut',
                    data: {
                        labels: themeLabels,
                        datasets: [{
                            data: stats.themes.values,
                            backgroundColor: [
                                '#3b82f6', '#10b981', '#0ea5e9', '#f59e0b', '#ef4444',
                                '#94a3b8', '#8b5cf6', '#ec4899', '#f97316'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { font: { size: 9 }, boxWidth: 8, padding: 8 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label = label.split(' (')[0];
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            const val = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const pct = total > 0 ? Math.round((val / total) * 100) : 0;
                                            label += `${val} items (${pct}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        cutout: '65%'
                    }
                });

                // Mise à jour du graphique de conformité
                const ctxComp = document.getElementById('complianceChart').getContext('2d');
                new Chart(ctxComp, {
                    type: 'pie',
                    data: {
                        labels: compLabels,
                        datasets: [{
                            data: stats.compliance.values,
                            backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 10 }, boxWidth: 10 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label = label.split(' (')[0];
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            const val = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const pct = total > 0 ? Math.round((val / total) * 100) : 0;
                                            label += `${val} items (${pct}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // Mise à jour du graphique de criticité
                const totalCrit = stats.criticite.values.reduce((a, b) => a + b, 0);
                const critLabels = stats.criticite.labels.map((l, i) => {
                    const pct = totalCrit > 0 ? Math.round((stats.criticite.values[i] / totalCrit) * 100) : 0;
                    return `${l} (${pct}%)`;
                });

                const ctxCrit = document.getElementById('criticiteChart').getContext('2d');
                new Chart(ctxCrit, {
                    type: 'pie',
                    data: {
                        labels: critLabels,
                        datasets: [{
                            data: stats.criticite.values,
                            backgroundColor: ['#dc2626', '#f59e0b', '#10b981'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 10 }, boxWidth: 10 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label = label.split(' (')[0];
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            const val = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const pct = total > 0 ? Math.round((val / total) * 100) : 0;
                                            label += `${val} items (${pct}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Erreur chargement stats:", error);
                // Fallback si DASHBOARD_DATA n'est pas trouvé
                document.getElementById('last-update-text').textContent = "⚠️ Erreur: dashboard_stats.js non chargé. Lancez run_tasks.bat.";
            }
        }

        document.addEventListener('DOMContentLoaded', loadDashboardData);
    </script>
</body>

</html>